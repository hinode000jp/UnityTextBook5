# 建物オブジェクトへの適用

## WalkThroughプロジェクトを開く

<br>

今回は前回までで学習したマテリアルの設定方法やライティングを実際の3Dオブジェクトに反映させる方法について解説していきます。

まずは以前作成した「WalkThrough」プロジェクトを開きましょう。  
他に3Dの屋内のデータがある場合はそちらを利用しても問題ありません。

<br>

![](img/image1-1.png)

プロジェクトを開いたら、プロジェクトウィンドウで新規フォルダを作成し、名前を「Prefabs」とします。  
そして、その中に以前作成したCapsuleをドラッグ&ドロップで入れてプレハブ化しておきましょう。

<br>

![](img/image1-2.png)

次に何もない新規のシーンを作成します。
もしくは初めからあるSampleSceneやWalkSceneを開いてください。
そしてMainCameraを削除します。

そしてプロジェクトウィンドウから、Capsuleと建物のプレハブをヒエラルキーウィンドウにドラッグ&ドロップします。

<br>

![](img/image1-3.png)

次に「PFB_Building_Full」に初めからついている「Light Probe Group」「Bathroom_ReflectionProbe」「Bedroom_ReflectionProbe」を非アクティブにします。
別の建物オブジェクトを利用している場合はこの作業を行わなくて大丈夫です。

これで準備は完了です。

<br>

## 3DオブジェクトをStaticにする

![](img/image1-4.png)

次に建物全体や家具などを全てStatic（静的）にします。  

Staticにする理由は、以前の講習で話した通り光をベイクすることによりデバイスへの負荷を減らす・陰影をリッチな表現にするためです。  
今回使用したアセットは既にStaticにチェックが入っているのでそのまま利用します。

また、マテリアルに関しても本来であれば前回までで学習したようにMetallicやSmoothnessといった値を変更して調整する必要があるのですが、今回使用しているアセットは既に調整が済んでいるのでこのまま利用したいと思います。

もしマテリアルを調整したい場合は、プロジェクトウィンドウの「FurnishiedCabin -> Meshes -> Materials」フォルダの中に格納されているマテリアルを変更してみてください。



<br>


## ライティングの設定

![](img/image1-5.png)

次にライティングの設定を行います。  
モデルをリアルに表現するにはライティングの設定がとても重要なのですが、思い通りの表現ができるようになるためには何度もライティングの調整と確認を繰り返し覚える必要があります。  

まずはUnityの「Edit -> ProjectSettings」を開きましょう。

<br>

![](img/image1-6.png)

そしてPlayerのOtherSettingsから「ColorSpace」を「Linear」に変更してください。  
Linearに変更すると、全体的に少し明るくなりさらに明るいところの白飛びや、暗いところが黒く潰れるといったことが少なくなります。  
しばらく待っているとUnityのシーンビューとゲームビューの色が若干変化します。  

<br>

### ガンマとリニアの違いについて

ガンマとリニアについての違いはUnityに限った話ではなく映像や写真を仕事で扱う方は知識としてあると思います。

現在のUnityのプロジェクトでは滅多なことがない限り（ハードウェアがガンマ形式しかサポートしていないなど）基本的に「Linear」を使用します。

Unityにおける２つの違いについて詳しく知りたい方は[こちら](https://docs.unity3d.com/ja/2019.4/Manual/LinearRendering-LinearOrGammaWorkflow.html)の公式ドキュメントをご確認ください。


<br>

## ライトマップの作成

![](img/image1-7.png)

次に「Window -> Rendering -> LightingSettings」を開き、そのウィンドウの右下にある「Generate Lighting」ボタンを押してください。  
結構時間がかかるのですが、しばらく待っているとライトマップを作成することができます。

<br>

### ライトマップとは

ライトマップとは、高負荷である光と影の計算を事前に行い、その情報をテクスチャに書き込んでおく機能のことです。  
ライトマップを作成することにより実行時の負荷を軽くすることができます。

<div class="point">
    ライトマッピングは、シーンのサーフェスの明るさを事前計算し、チャートやライトマップに結果を保存して後で使用するための処理です。

    Unity は プログレッシブライトマッパー と呼ばれるシステムを使用しています。プログレッシブライトマッパーは、メッシュ、マテリアル、テクスチャ、ライトを考慮しながら、シーンの設定に基づいてシーンのライトマップをベイクします。ライトマッピングはレンダリングエンジンの不可欠な部分です。ライトマップが作成されると、ゲームオブジェクトは自動的にそれらを使用します。
</div>

<br>

![](img/image1-8.png)

ここまでできたら実際に実行してみましょう。

デフォルトの状態よりもだいぶ明るい雰囲気になり、PCへの負荷も減ったかと思います。  
しかし、最初からついていたリフレクションプローブなども非アクティブにしたので鏡が反射しなくなっています。  
ですので、次はこちらを修正しましょう。

<br>

## リフレクションプローブを適用させる

![](img/image1-9.png)

ヒエラルキーウィンドウから新規で「ReflectionProbe」を作成してください。  
鏡からみた景色を表示したいので、位置を鏡と同じポイントにしてください。  
そしてLightingSettingsから「GenerateLighting」をクリックすると、きちんと鏡のリフレクションプローブが反映されました。  
実際に実行して確認してみましょう。

<br>

![](img/image1-10.png)

同様にバスルームの鏡用にもリフレクションプローブを作成し、GenerateLightingを実行してみましょう。

若干周りの背景に対して反射している背景が大きいように感じるので、そういった場合はReflectionProbeの「BoxProjection」にチェックを入れてください。  
BoxProjectionをOnにすると、カメラの位置が正しく考慮されて、家具などの写り込みの位置が正しく修正されます。

変更したらインスペクターウィンドウのReflectionProbeコンポーネントのBakeをクリックしておきましょう。

<div class="point">
    Box Projection オプションを使うと、プローブから限定した距離でリフレクションキューブマップを作成することができます。そのため、オブジェクトはキューブマップの壁からの距離に応じて異なるサイズの反射を表示できます。 周囲のキューブマップのサイズは、Box Size プロパティで指定されたプローブの有効範囲によって決まります。例えば、部屋の内部を映すプローブは、部屋の大きさに合わせてサイズを設定する必要があります。 Project Settings__　> Graphics__　> Tier Settings で __Box Projection__　をグローバルに有効にすることができます。ただし、無限投影が望ましい場合、特定のリフレクションプローブに対して、Reflection Probe インスペクターでオプションをオフにすることができます。
</div>

<br>

![](img/image1-14.png)

最後に部屋全体にもReflectionProbeを適用させたいので部屋の中心に新規でReflectionProbeを作成し、BoxProjectionにチェックを入れBakeをクリックしてください。

<br>

![](img/image1-15.png)

これで、このような細かな家具にも反射が適用されました。

<br>

## SkyBoxを適用させる

![](img/image1-11.png)

窓の外が何もない空間なので、SkyBoxを変更して少し雰囲気を出したいと思います。  
AssetStoreを開き、検索バーに「skybox」と入力し検索してください。価格の部分で無料にチェックを入れると様々なSkyBoxが表示されると思いますので、任意のものを選択し、インポートしてください。  
教材では「3D Skybox Pro」というアセットをインポートしました。

<br>

![](img/image1-12.png)

アセットに入っているSkybox用のマテリアルをシーンビューの何もない場所にドラッグ&ドロップすると、このように窓の外の景色が変わるかと思います。

<br>

## ライティングの調整

![](img/image1-13.png)

既にライティングの設定が済んでいるアセットであればいいのですが、もしライティングがまだの場合は前回までの講習を参考に自分なりにライティングの設定をしてみましょう。  
ライトの色や強度を変えてみたり、自然光を増やしたりするのもいいと思います。ライティングに関してはセンスや慣れといった部分が強いと思いますので、何度も自分の納得のいくまでトライ&エラーを繰り返して学習してください。

現在のライティングの正確な見た目を確認したい時はLightingSettingsの「GenerateLighting」をクリックしてください。  

<br>

## 鏡のマテリアル

最後に鏡の質感を再現するマテリアルを作成します。鏡は写り込みの範囲等を設定する必要があるので少し複雑になります。

### Sphereを複製する

![](img/image1-16.png)

ヒエラルキーウィンドウでSphereを選択し、Windowsの方は「Ctrl + d」、Macの方は「Cmd + d」を押してスフィアを複製します。  
そして名前を「MirrorSphere」とし、PositionXを-1.5に変更してください。  
これで複製されたスフィアが横に移動されました。

次に、プロジェクトウィンドウからGreenMaterialを選択し、Sphereと同様に複製します。  
そして名前を「MirrorMaterial」に変更し、カラーを白に、MetallicとSmoothnessを1にしてください。  
最後にこのMirrorMaterialをMirrorSphereアタッチして準備は完了です。

<br>

### ReflectionProbeの配置

次に、周囲の風景を反射させるためにReflectionProbeを作成します。  
こちらは容易に反射を作成することができるのですが、処理が重いため多用する場合は注意してください。

<br>

![](img/image1-17.png)

ヒエラルキーウィンドウで右クリックし、「Light -> ReflectionProbe」を選択してください。  
そうすると、新規でReflectionProebeが作成されるので、座標をMirrorSphereと同じ位置にしてください。

<br>

![](img/image1-18.png)

ReflectionProbeのデフォルトでの反射対象オブジェクトは静的（static）オブジェクトのみになっています。  
ですので、ヒエラルキーウィンドウでPlaneと全てのスフィアを選択し、インスペクターウィンドウで「Static」にチェックを入れてください。

<br>

![](img/image1-19.png)

そうすると、自動的にBakeが実行されます。しばらく待っているとMirrorSphereに周りの背景が反射して表示されるようになったかと思います。

<div class="point">
    <h3>Bakeとは</h3>
    Bakeとは、あらかじめ影や反射を計算してテクスチャに反映させる処理のことです。  
    リアルタイムではなくベイク（焼き込み）にすることでアプリケーションの負荷を減らし画面の角付きやパソコンへの負荷を減らすことができます。
</div>

<br>

自動でBakeしなかった場合はWindowタブから「Rendering -> LightingSettings」から「AutoGenerate」をチェックしてください。

<br>

![](img/image1-20.png)

これで綺麗に周りの背景を反射する鏡のマテリアルになったのですが、最初に作成したスフィアを見てもらうと、こちらも同様な形で反射が適用されています。

<br>

![](img/image1-21.png)

こちらは特に反射は適用させる必要がないのでReflectionProbeを無効にしたいと思います。  
無効にする方法は、ヒエラルキーウィンドウでSphereを選択し、インスペクターウィンドウのMeshRendererコンポーネントにある「ReflectionProbe」をOffにするだけです。

同様にGlassSphereのReflectionProbeも変更したいと思います。  
ただしこちらはガラスを表現したマテリアルなので、周りからの反射を反映させたいと思います。

現在は最初に作成したReflectionProbeの反射が反映されているので不自然な写り込みになっているので、このGlassSphere用のReflectionProbeを作成します。

<br>

![](img/image1-22.png)

まずはヒエラルキーウィンドウから「Light -> ReflectionProbe」を新規作成してください。  
そして座標をGlassSphereと同じ位置にします。

少しゲームビューのカメラの位置が遠いので近づけておきましょう。


<br>

![](img/image1-23.png)

もし別のReflectionProbeも反映されている場合は、インスペクターウィンドウのReflectionProbesをSimpleに変更してください。  
これでガラスの反射の方も完成です。

ここまで作り終わりましたら忘れずに保存しておきましょう。
